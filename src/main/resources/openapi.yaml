openapi: 3.0.1

info:
  title: SoccorsoWeb API
  version: v1.0
  description: API per il sistema di gestione richieste di soccorso

servers:
  - url: http://localhost:8080
    description: Development server

# Sezione di sicurezza
security:
  - bearerAuth: []

paths:
  # ========================================
  # API APERTE (senza autenticazione)
  # ========================================

  # --- Auth Controller - API Ausiliarie ---
  /swa/open/auth/sign-up:
    post:
      tags:
        - auth-controller
      summary: Registrazione nuovo utente
      operationId: signUp
      security: []  # Endpoint pubblico
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/UserRequest"
      responses:
        "200":
          description: Registrazione completata con successo
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/UserResponse"
        "400":
          $ref: "#/components/responses/BadRequest"
        "422":
          $ref: "#/components/responses/UnprocessableEntity"
        "500":
          $ref: "#/components/responses/InternalServerError"

  /swa/open/auth/login:
    post:
      tags:
        - auth-controller
      summary: Autenticazione utente
      operationId: login
      security: []  # Endpoint pubblico
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/LoginRequest"
      responses:
        "200":
          description: Login effettuato con successo
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/UserResponse"
        "400":
          $ref: "#/components/responses/BadRequest"
        "401":
          $ref: "#/components/responses/Unauthorized"
        "500":
          $ref: "#/components/responses/InternalServerError"

  /swa/open/auth/logout:
    post:
      tags:
        - auth-controller
      summary: Logout utente
      operationId: logout
      security: []  # Endpoint pubblico
      responses:
        "200":
          description: Logout completato
          content:
            application/json:
              schema:
                type: string
        "400":
          $ref: "#/components/responses/BadRequest"
        "500":
          $ref: "#/components/responses/InternalServerError"

  # --- Richiesta Open Controller - API Principali ---
  /swa/open/richiesta/nuova-richiesta:
    post:
      tags:
        - richiesta-open-controller
      summary: Creazione nuova richiesta di soccorso (pubblica)
      operationId: nuovaRichiesta
      security: []  # Endpoint pubblico
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/RichiestaSoccorsoRequest"
      responses:
        "200":
          description: Richiesta creata con successo
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/RichiestaSoccorsoResponse"
        "400":
          $ref: "#/components/responses/BadRequest"
        "422":
          $ref: "#/components/responses/UnprocessableEntity"
        "500":
          $ref: "#/components/responses/InternalServerError"

  # --- Richiesta Open Controller - API Ausiliarie ---
  /swa/open/richiesta/{id}/convalida/{token}:
    get:
      tags:
        - richiesta-open-controller
      summary: Convalida richiesta di soccorso tramite token
      operationId: convalidaRichiesta
      security: []  # Endpoint pubblico
      parameters:
        - name: id
          in: path
          required: true
          schema:
            type: integer
            format: int64
        - name: token
          in: path
          required: true
          schema:
            type: string
      responses:
        "200":
          description: Richiesta convalidata
          content:
            application/json:
              schema:
                type: object
                additionalProperties:
                  type: object
        "400":
          $ref: "#/components/responses/BadRequest"
        "404":
          $ref: "#/components/responses/NotFound"
        "422":
          $ref: "#/components/responses/UnprocessableEntity"
        "500":
          $ref: "#/components/responses/InternalServerError"

  # ========================================
  # API PROTETTE (richiedono autenticazione)
  # ========================================

  # --- Richiesta API Controller - API Principali ---
  /swa/api/richiesta/visualizza-richieste-filtrate/{stato}:
    get:
      tags:
        - richiesta-api-controller
      summary: Visualizza richieste filtrate per stato
      operationId: richiesteFiltrate
      security:
        - bearerAuth: []
      parameters:
        - name: stato
          in: path
          required: true
          schema:
            type: string
            enum: [PENDING, IN_PROGRESS, COMPLETED, CANCELLED]
      responses:
        "200":
          description: Lista richieste filtrate
          content:
            application/json:
              schema:
                type: array
                items:
                  $ref: "#/components/schemas/RichiestaSoccorsoResponse"
        "400":
          $ref: "#/components/responses/BadRequest"
        "401":
          $ref: "#/components/responses/Unauthorized"
        "404":
          $ref: "#/components/responses/NotFound"
        "500":
          $ref: "#/components/responses/InternalServerError"

  /swa/api/richiesta/modifica-stato/{id}/{nuovoStato}:
    put:
      tags:
        - richiesta-api-controller
      summary: Modifica stato di una richiesta
      operationId: modificaStatoRichiesta
      security:
        - bearerAuth: []
      parameters:
        - name: id
          in: path
          required: true
          schema:
            type: integer
            format: int64
        - name: nuovoStato
          in: path
          required: true
          schema:
            type: string
            enum: [PENDING, IN_PROGRESS, COMPLETED, CANCELLED]
      responses:
        "200":
          description: Stato modificato con successo
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/RichiestaSoccorsoResponse"
        "400":
          $ref: "#/components/responses/BadRequest"
        "401":
          $ref: "#/components/responses/Unauthorized"
        "404":
          $ref: "#/components/responses/NotFound"
        "422":
          $ref: "#/components/responses/UnprocessableEntity"
        "500":
          $ref: "#/components/responses/InternalServerError"

  # --- Richiesta API Controller - API Ausiliarie ---
  /swa/api/richiesta/dettagli-richiesta/{id}:
    get:
      tags:
        - richiesta-api-controller
      summary: Visualizza dettagli di una richiesta specifica
      operationId: dettagliRichiesta
      security:
        - bearerAuth: []
      parameters:
        - name: id
          in: path
          required: true
          schema:
            type: integer
            format: int64
      responses:
        "200":
          description: Dettagli richiesta
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/RichiestaSoccorsoResponse"
        "400":
          $ref: "#/components/responses/BadRequest"
        "401":
          $ref: "#/components/responses/Unauthorized"
        "404":
          $ref: "#/components/responses/NotFound"
        "500":
          $ref: "#/components/responses/InternalServerError"

  /swa/api/richiesta/elimina-missione/{id}:
    delete:
      tags:
        - richiesta-api-controller
      summary: Elimina richiesta
      operationId: eliminaRichiesta
      security:
        - bearerAuth: []
      parameters:
        - name: id
          in: path
          required: true
          schema:
            type: integer
            format: int64
      responses:
        "200":
          description: Richiesta eliminata
        "400":
          $ref: "#/components/responses/BadRequest"
        "401":
          $ref: "#/components/responses/Unauthorized"
        "404":
          $ref: "#/components/responses/NotFound"
        "500":
          $ref: "#/components/responses/InternalServerError"

  # --- Missione Controller - API Principali ---
  /swa/api/missione/inserisci-missione:
    post:
      tags:
        - missione-controller
      summary: Crea una nuova missione
      operationId: inserisciMissione
      security:
        - bearerAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/MissioneRequest"
      responses:
        "200":
          description: Missione creata con successo
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/MissioneResponse"
        "400":
          $ref: "#/components/responses/BadRequest"
        "401":
          $ref: "#/components/responses/Unauthorized"
        "422":
          $ref: "#/components/responses/UnprocessableEntity"
        "500":
          $ref: "#/components/responses/InternalServerError"

  /swa/api/missione/modifica-stato/{id}/{nuovoStato}:
    put:
      tags:
        - missione-controller
      summary: Modifica stato di una missione
      operationId: modificaStatoMissione
      security:
        - bearerAuth: []
      parameters:
        - name: id
          in: path
          required: true
          schema:
            type: integer
            format: int64
        - name: nuovoStato
          in: path
          required: true
          schema:
            type: string
            enum: [ASSIGNED, IN_PROGRESS, COMPLETED, CANCELLED]
      responses:
        "200":
          description: Stato modificato con successo
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/MissioneResponse"
        "400":
          $ref: "#/components/responses/BadRequest"
        "401":
          $ref: "#/components/responses/Unauthorized"
        "404":
          $ref: "#/components/responses/NotFound"
        "422":
          $ref: "#/components/responses/UnprocessableEntity"
        "500":
          $ref: "#/components/responses/InternalServerError"

  /swa/api/missione/chiudi-missione/{id}:
    put:
      tags:
        - missione-controller
      summary: Chiude una missione
      operationId: chiudiMissione
      security:
        - bearerAuth: []
      parameters:
        - name: id
          in: path
          required: true
          schema:
            type: integer
            format: int64
      responses:
        "200":
          description: Missione chiusa con successo
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/MissioneResponse"
        "400":
          $ref: "#/components/responses/BadRequest"
        "401":
          $ref: "#/components/responses/Unauthorized"
        "404":
          $ref: "#/components/responses/NotFound"
        "422":
          $ref: "#/components/responses/UnprocessableEntity"
        "500":
          $ref: "#/components/responses/InternalServerError"

  /swa/api/missione/annulla-missione/{id}:
    put:
      tags:
        - missione-controller
      summary: Annulla una missione
      operationId: annullaMissione
      security:
        - bearerAuth: []
      parameters:
        - name: id
          in: path
          required: true
          schema:
            type: integer
            format: int64
      responses:
        "200":
          description: Missione annullata con successo
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/MissioneResponse"
        "400":
          $ref: "#/components/responses/BadRequest"
        "401":
          $ref: "#/components/responses/Unauthorized"
        "404":
          $ref: "#/components/responses/NotFound"
        "422":
          $ref: "#/components/responses/UnprocessableEntity"
        "500":
          $ref: "#/components/responses/InternalServerError"

  # --- Missione Controller - API Ausiliarie ---
  /swa/api/missione/dettagli-missione/{id}:
    get:
      tags:
        - missione-controller
      summary: Visualizza dettagli di una missione specifica
      operationId: dettagliMissione
      security:
        - bearerAuth: []
      parameters:
        - name: id
          in: path
          required: true
          schema:
            type: integer
            format: int64
      responses:
        "200":
          description: Dettagli missione
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/MissioneResponse"
        "400":
          $ref: "#/components/responses/BadRequest"
        "401":
          $ref: "#/components/responses/Unauthorized"
        "404":
          $ref: "#/components/responses/NotFound"
        "500":
          $ref: "#/components/responses/InternalServerError"

  /swa/api/missione/missioni-operatore/{id}:
    get:
      tags:
        - missione-controller
      summary: Visualizza missioni assegnate a un operatore
      operationId: missioniOperatore
      security:
        - bearerAuth: []
      parameters:
        - name: id
          in: path
          required: true
          schema:
            type: integer
            format: int64
      responses:
        "200":
          description: Lista missioni operatore
          content:
            application/json:
              schema:
                type: array
                items:
                  $ref: "#/components/schemas/MissioneResponse"
        "400":
          $ref: "#/components/responses/BadRequest"
        "401":
          $ref: "#/components/responses/Unauthorized"
        "404":
          $ref: "#/components/responses/NotFound"
        "500":
          $ref: "#/components/responses/InternalServerError"

  /swa/api/missione/missioni-non-positive:
    get:
      tags:
        - missione-controller
      summary: Visualizza missioni con valutazione negativa
      operationId: missioniValutateNegative
      security:
        - bearerAuth: []
      responses:
        "200":
          description: Lista missioni valutate negativamente
          content:
            application/json:
              schema:
                type: array
                items:
                  $ref: "#/components/schemas/MissioneResponse"
        "400":
          $ref: "#/components/responses/BadRequest"
        "401":
          $ref: "#/components/responses/Unauthorized"
        "500":
          $ref: "#/components/responses/InternalServerError"

  /swa/api/missione/valuta-missione/{id}/{livelloSuccesso}:
    put:
      tags:
        - missione-controller
      summary: Valuta l'esito di una missione
      operationId: valutaMissione
      security:
        - bearerAuth: []
      parameters:
        - name: id
          in: path
          required: true
          schema:
            type: integer
            format: int64
        - name: livelloSuccesso
          in: path
          required: true
          schema:
            type: integer
            format: int32
            minimum: 1
            maximum: 5
      responses:
        "200":
          description: Missione valutata con successo
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/MissioneResponse"
        "400":
          $ref: "#/components/responses/BadRequest"
        "401":
          $ref: "#/components/responses/Unauthorized"
        "404":
          $ref: "#/components/responses/NotFound"
        "422":
          $ref: "#/components/responses/UnprocessableEntity"
        "500":
          $ref: "#/components/responses/InternalServerError"

  /swa/api/missione/elimina-missione/{id}:
    delete:
      tags:
        - missione-controller
      summary: Elimina una missione
      operationId: eliminaMissione
      security:
        - bearerAuth: []
      parameters:
        - name: id
          in: path
          required: true
          schema:
            type: integer
            format: int64
      responses:
        "200":
          description: Missione eliminata
        "400":
          $ref: "#/components/responses/BadRequest"
        "401":
          $ref: "#/components/responses/Unauthorized"
        "404":
          $ref: "#/components/responses/NotFound"
        "500":
          $ref: "#/components/responses/InternalServerError"

  # --- Operatore Controller - API Principali ---
  /swa/api/operatore/disponibile:
    get:
      tags:
        - operatore-controller
      summary: Visualizza lista operatori disponibili
      operationId: operatoreDisponibile
      security:
        - bearerAuth: []
      responses:
        "200":
          description: Lista operatori disponibili
          content:
            application/json:
              schema:
                type: array
                items:
                  $ref: "#/components/schemas/UserResponse"
        "400":
          $ref: "#/components/responses/BadRequest"
        "401":
          $ref: "#/components/responses/Unauthorized"
        "500":
          $ref: "#/components/responses/InternalServerError"

  # --- Operatore Controller - API Ausiliarie ---
  /swa/api/operatore/dettagli-operatore/{id}:
    get:
      tags:
        - operatore-controller
      summary: Visualizza dettagli di un operatore specifico
      operationId: dettagliOperatore
      security:
        - bearerAuth: []
      parameters:
        - name: id
          in: path
          required: true
          schema:
            type: integer
            format: int64
      responses:
        "200":
          description: Dettagli operatore
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/UserResponse"
        "400":
          $ref: "#/components/responses/BadRequest"
        "401":
          $ref: "#/components/responses/Unauthorized"
        "404":
          $ref: "#/components/responses/NotFound"
        "500":
          $ref: "#/components/responses/InternalServerError"

components:
  # Definizione degli schemi di sicurezza
  securitySchemes:
    bearerAuth:
      type: http
      scheme: bearer
      bearerFormat: JWT
      description: Token JWT per autenticazione. Formato "Bearer {token}"

  # Risposte comuni
  responses:
    BadRequest:
      description: Bad Request - Richiesta non valida
      content:
        application/json:
          schema:
            $ref: "#/components/schemas/ProblemDetail"

    Unauthorized:
      description: Unauthorized - Autenticazione richiesta o token non valido
      content:
        application/json:
          schema:
            $ref: "#/components/schemas/ProblemDetail"

    NotFound:
      description: Not Found - Risorsa non trovata
      content:
        application/json:
          schema:
            $ref: "#/components/schemas/ProblemDetail"

    UnprocessableEntity:
      description: Unprocessable Entity - Dati non validi
      content:
        application/json:
          schema:
            $ref: "#/components/schemas/ProblemDetail"

    InternalServerError:
      description: Internal Server Error - Errore del server
      content:
        application/json:
          schema:
            $ref: "#/components/schemas/ProblemDetail"

  # Schemi dei dati
  schemas:
    ProblemDetail:
      type: object
      properties:
        type:
          type: string
          format: uri
        title:
          type: string
        status:
          type: integer
          format: int32
        detail:
          type: string
        instance:
          type: string
          format: uri
        properties:
          type: object
          additionalProperties:
            type: object

    RichiestaSoccorsoRequest:
      type: object
      required:
        - descrizione
        - indirizzo
        - nome_segnalante
        - email_segnalante
      properties:
        descrizione:
          type: string
          minLength: 10
          maxLength: 1000
        indirizzo:
          type: string
          minLength: 5
          maxLength: 255
        latitudine:
          type: number
          format: double
          minimum: -90.0
          maximum: 90.0
        longitudine:
          type: number
          format: double
          minimum: -180.0
          maximum: 180.0
        nome_segnalante:
          type: string
          minLength: 2
          maxLength: 100
        email_segnalante:
          type: string
          format: email
        telefono_segnalante:
          type: string
          pattern: '^[0-9+\-\s()]+$'
          maxLength: 20
        foto_url:
          type: string
          format: uri

    RichiestaSoccorsoResponse:
      type: object
      properties:
        id:
          type: integer
          format: int64
        descrizione:
          type: string
        indirizzo:
          type: string
        latitudine:
          type: number
          format: double
        longitudine:
          type: number
          format: double
        nome_segnalante:
          type: string
        email_segnalante:
          type: string
        telefono_segnalante:
          type: string
        foto_url:
          type: string
        stato:
          type: string
          enum: [PENDING, IN_PROGRESS, COMPLETED, CANCELLED]
        convalidata_at:
          type: string
          format: date-time
        created_at:
          type: string
          format: date-time
        updated_at:
          type: string
          format: date-time
        missione_id:
          type: integer
          format: int64
        ip_origine:
          type: string
        token_convalida:
          type: string

    MissioneRequest:
      type: object
      required:
        - richiesta_id
        - obiettivo
        - caposquadra_id
      properties:
        richiesta_id:
          type: integer
          format: int64
        obiettivo:
          type: string
          minLength: 10
          maxLength: 500
        caposquadra_id:
          type: integer
          format: int64
        posizione:
          type: string
        latitudine:
          type: number
          format: double
        longitudine:
          type: number
          format: double
        operatori_ids:
          type: array
          uniqueItems: true
          items:
            type: integer
            format: int64

    MissioneResponse:
      type: object
      properties:
        id:
          type: integer
          format: int64
        richiesta_id:
          type: integer
          format: int64
        obiettivo:
          type: string
        posizione:
          type: string
        latitudine:
          type: number
          format: double
        longitudine:
          type: number
          format: double
        caposquadra:
          $ref: "#/components/schemas/UserResponse"
        inizio_at:
          type: string
          format: date-time
        fine_at:
          type: string
          format: date-time
        livello_successo:
          type: integer
          format: int32
          minimum: 1
          maximum: 5
        commenti_finali:
          type: string
        stato:
          type: string
          enum: [ASSIGNED, IN_PROGRESS, COMPLETED, CANCELLED]
        created_at:
          type: string
          format: date-time
        updated_at:
          type: string
          format: date-time
        operatori:
          type: array
          uniqueItems: true
          items:
            $ref: "#/components/schemas/UserResponse"
        numero_operatori:
          type: integer
          format: int32
        richiesta:
          $ref: "#/components/schemas/RichiestaSoccorsoResponse"

    UserRequest:
      type: object
      required:
        - email
        - password
        - nome
        - cognome
      properties:
        email:
          type: string
          format: email
        password:
          type: string
          minLength: 6
          maxLength: 100
        nome:
          type: string
          minLength: 2
          maxLength: 100
        cognome:
          type: string
          minLength: 2
          maxLength: 100
        data_nascita:
          type: string
          format: date
        telefono:
          type: string
          maxLength: 20
        indirizzo:
          type: string
          maxLength: 255

    UserResponse:
      type: object
      properties:
        id:
          type: integer
          format: int64
        email:
          type: string
        nome:
          type: string
        cognome:
          type: string
        data_nascita:
          type: string
          format: date
        telefono:
          type: string
        indirizzo:
          type: string
        attivo:
          type: boolean
        disponibile:
          type: boolean
        created_at:
          type: string
          format: date-time
        updated_at:
          type: string
          format: date-time
        roles:
          type: array
          uniqueItems: true
          items:
            $ref: "#/components/schemas/RoleResponse"
        token:
          type: string

    RoleResponse:
      type: object
      properties:
        id:
          type: integer
          format: int64
        name:
          type: string
          enum: [ADMIN, OPERATOR, USER]

    LoginRequest:
      type: object
      required:
        - email
        - password
      properties:
        email:
          type: string
          format: email
        password:
          type: string

tags:
  - name: auth-controller
    description: Gestione autenticazione e autorizzazione
  - name: richiesta-open-controller
    description: API pubbliche per richieste di soccorso
  - name: richiesta-api-controller
    description: API protette per gestione richieste di soccorso
  - name: missione-controller
    description: Gestione missioni di soccorso
  - name: operatore-controller
    description: Gestione operatori
